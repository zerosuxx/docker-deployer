#!/bin/bash

set -e

DIR="$1"
SYNCER_URL="$2"
TOKEN="$3"

if [[ -z "$DIR" ]] || [[ -z "$SYNCER_URL" ]] || [[ -z "$TOKEN" ]]; then
  echo 'Usage sync-files DIR SYNCER_URL TOKEN'
  exit
fi

cd "$DIR" || exit

echo 'Start syncing files...'

echo "Fetching remote file modification times..."
remoteFiles=$(curl --fail -sS -H "Auth-Token: $TOKEN" "$SYNCER_URL?action=files" | jq)

if [ "$remoteFiles" == "" ]
then
  echo "Error: fetching remote file modification times failed!"
  exit 1
fi

postParams=""
i=0
while read -rd $'\0' file; do
  modifiedTime=$(date -r "$file" "+%s")
  remoteModifiedTime=$(echo "$remoteFiles" | jq -r '."'"$file"'"')

  if [ "$remoteModifiedTime" == null ] || [ "$modifiedTime" -lt "$remoteModifiedTime" ]
  then
    postParams+=" -F files[]=@$file"
    postParams+=" -F filePaths[]=$file"

    i=$((i+1))
  fi
  postParams+=" -F fileList[]=$file"
done < <(find * -type f -name '*.*' -print0)

echo "Uploading files: $i"

if [ $i -gt 0 ]
then
  curl --fail -sS -H "Auth-Token: $TOKEN" $postParams "$SYNCER_URL" | jq | exit 1
fi
